// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  address         String           @unique
  username        String?          @unique
  role            UserRole         @default(USER)
  kycTier         Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  bots            Bot[]
  deployments     DeploymentTransaction[]
  comments        Comment[]
  likes           Like[]
  followers       Follow[]         @relation("follower")
  following       Follow[]         @relation("following")
  achievements    UserAchievement[]
  sessions        Session[]
  
  @@index([address])
}

model Session {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  token           String           @unique
  expiresAt       DateTime
  createdAt       DateTime         @default(now())
  
  @@index([userId])
  @@index([token])
}

model Bot {
  id              String           @id @default(cuid())
  tokenId         Int              @unique // Unique NFT-like token ID
  name            String
  avatar          String           // preset avatar identifier
  prompt          String           @db.VarChar(1000) // 1000 char strategy
  personality     BotPersonality   @default(WORKER) // Crime metaverse personality
  isDemo          Boolean          @default(false) // System demo bots
  modelType       AIModel          // gpt-4o, claude-3-5-sonnet, etc.
  creatorId       String
  creator         User             @relation(fields: [creatorId], references: [id])
  isActive        Boolean          @default(true)
  stats           Json             @default("{}") // wins, losses, earnings
  
  // Metaverse integration
  channel         String           @default("main") // Channel assignment for world distribution
  metaverseAgentId String?         // AI Town agent ID
  metaverseCharacter String?        // Character sprite ID (f1-f8, criminal1, etc.)
  currentZone     String?          // Current zone (casino, darkAlley, suburb)
  metaversePosition Json?          @default("{}") // {x: number, y: number, worldInstanceId: string}
  lastZoneChange  DateTime?        // Track zone transitions
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  deploymentTx    DeploymentTransaction?
  queueEntries    QueueEntry[]
  tournaments     TournamentParticipant[]
  matches         MatchParticipant[]
  comments        Comment[]
  likes           Like[]
  
  // Economy relations
  equipment       BotEquipment[]
  house           BotHouse?
  activityScore   BotActivityScore?
  lootboxRewards  LootboxReward[]
  initiatedTrades Trade[]          @relation("initiator")
  receivedTrades  Trade[]          @relation("receiver")
  robberyAttempts RobberyLog[]     @relation("robber")
  robberyDefenses RobberyLog[]     @relation("victim")
  
  // Energy system
  energy          BotEnergy?
  energyPurchases EnergyPurchase[]
  
  // Metaverse sync
  botSync         BotSync?
  
  @@index([creatorId])
  @@index([createdAt])
  @@index([isActive])
  @@index([channel])
  @@index([metaverseAgentId])
  @@index([tokenId])
}

model DeploymentTransaction {
  id              String           @id @default(cuid())
  botId           String           @unique
  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  txHash          String           @unique
  amount          Decimal          @db.Decimal(78, 18) // deployment fee in ETH
  status          TxStatus         @default(PENDING)
  createdAt       DateTime         @default(now())
  
  @@index([userId])
  @@index([txHash])
  @@index([status])
}

model QueueEntry {
  id              String           @id @default(cuid())
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id])
  queueType       QueueType        @default(STANDARD)
  priority        Int              @default(0) // higher = faster matching
  status          QueueStatus      @default(WAITING)
  enteredAt       DateTime         @default(now())
  expiresAt       DateTime         // 24 hours from entry
  matchedAt       DateTime?
  
  @@index([botId])
  @@index([status])
  @@index([queueType])
  @@index([priority])
}

model Match {
  id              String           @id @default(cuid())
  type            MatchType        @default(TOURNAMENT)
  status          MatchStatus      @default(SCHEDULED)
  gameHistory     Json             // complete poker game state
  decisions       Json             // all AI decisions made
  result          Json?            // final rankings and points
  replayUrl       String?          // S3/R2 URL for replay file
  createdAt       DateTime         @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  
  participants    MatchParticipant[]
  aiDecisions     AIDecision[]
  tournament      Tournament?      @relation(fields: [tournamentId], references: [id])
  tournamentId    String?
  lootboxRewards  LootboxReward[]
  
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

model MatchParticipant {
  id              String           @id @default(cuid())
  matchId         String
  match           Match            @relation(fields: [matchId], references: [id])
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id])
  position        Int              // seat position
  finalRank       Int?             // 1st, 2nd, etc.
  points          Int              @default(0)
  
  @@unique([matchId, botId])
  @@index([matchId])
  @@index([botId])
}

model AIDecision {
  id              String           @id @default(cuid())
  matchId         String
  match           Match            @relation(fields: [matchId], references: [id])
  botId           String
  handNumber      Int
  decision        Json             // action, reasoning, timing
  gameState       Json             // game state at decision time
  timestamp       DateTime         @default(now())
  
  @@index([matchId])
  @@index([botId])
}

model Tournament {
  id              String           @id @default(cuid())
  name            String
  type            TournamentType
  status          TournamentStatus @default(UPCOMING)
  entryFee        Decimal          @db.Decimal(78, 18)
  prizePool       Decimal          @db.Decimal(78, 18)
  startTime       DateTime
  endTime         DateTime
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  participants    TournamentParticipant[]
  matches         Match[]
  
  @@index([type])
  @@index([status])
  @@index([startTime])
}

model TournamentParticipant {
  id              String           @id @default(cuid())
  tournamentId    String
  tournament      Tournament       @relation(fields: [tournamentId], references: [id])
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id])
  score           Float            @default(0)
  rank            Int?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@unique([tournamentId, botId])
  @@index([tournamentId])
  @@index([botId])
}

model Comment {
  id              String           @id @default(cuid())
  content         String
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id])
  createdAt       DateTime         @default(now())
  
  @@index([botId])
  @@index([userId])
}

model Like {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id])
  createdAt       DateTime         @default(now())
  
  @@unique([userId, botId])
  @@index([botId])
  @@index([userId])
}

model Follow {
  id              String           @id @default(cuid())
  followerAddress String
  follower        User             @relation("follower", fields: [followerAddress], references: [address])
  followingAddress String
  following       User             @relation("following", fields: [followingAddress], references: [address])
  createdAt       DateTime         @default(now())
  
  @@unique([followerAddress, followingAddress])
  @@index([followerAddress])
  @@index([followingAddress])
}

model Achievement {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String
  imageUrl        String?
  rarity          AchievementRarity
  createdAt       DateTime         @default(now())
  
  users           UserAchievement[]
}

model UserAchievement {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id])
  achievementId   String
  achievement     Achievement      @relation(fields: [achievementId], references: [id])
  unlockedAt      DateTime         @default(now())
  
  @@unique([userId, achievementId])
  @@index([userId])
}

enum UserRole {
  USER
  DEVELOPER
  ADMIN
}

enum AIModel {
  // OpenAI Models
  GPT_4O
  GPT_4O_MINI
  O3
  O3_MINI
  O3_PRO
  
  // Anthropic Claude Models
  CLAUDE_3_5_SONNET
  CLAUDE_3_5_HAIKU
  CLAUDE_3_OPUS
  CLAUDE_4_OPUS
  CLAUDE_4_SONNET
  
  // DeepSeek Models
  DEEPSEEK_CHAT
  DEEPSEEK_R1
  DEEPSEEK_V3
  
  // Alibaba Qwen Models
  QWEN_2_5_72B
  QWQ_32B
  QVQ_72B_PREVIEW
  QWEN_2_5_MAX
  
  // xAI Models
  GROK_3
  
  // Kimi Models
  KIMI_K2
  
  // Google Gemini Models
  GEMINI_2_5_PRO
  GEMINI_2_5_PRO_DEEP_THINK
  
  // Meta Llama Models
  LLAMA_3_1_405B
  LLAMA_3_1_70B
  LLAMA_3_2_90B
  
  // Mistral Models
  MIXTRAL_8X22B
}

enum TxStatus {
  PENDING
  CONFIRMED
  FAILED
  REFUNDED
}

enum QueueType {
  STANDARD
  PRIORITY
  PREMIUM
}

enum QueueStatus {
  WAITING
  MATCHED
  EXPIRED
  CANCELLED
}

enum MatchType {
  TOURNAMENT
  HEAD_TO_HEAD
  PRACTICE
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum TournamentType {
  ROOKIE
  PRO
  CHAMPIONSHIP
}

enum TournamentStatus {
  UPCOMING
  LIVE
  COMPLETED
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

// Economy System Enums
enum EquipmentType {
  WEAPON
  ARMOR
  TOOL
  ACCESSORY
}

enum ItemRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum FurnitureType {
  DECORATION
  FUNCTIONAL
  DEFENSIVE
  TROPHY
}

enum BotPersonality {
  CRIMINAL
  GAMBLER
  WORKER
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  FAILED
  DISABLED
}

enum ChannelType {
  MAIN
  REGIONAL
  VIP
  TEST
}

enum ChannelStatus {
  ACTIVE
  FULL
  DRAINING
  MAINTENANCE
}

// Economy System Models
model BotEquipment {
  id              String           @id @default(cuid())
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  name            String
  equipmentType   EquipmentType
  rarity          ItemRarity
  powerBonus      Int              @default(0)
  defenseBonus    Int              @default(0)
  equipped        Boolean          @default(false)
  metadata        Json             @default("{}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([botId])
  @@index([equipped])
}

model BotHouse {
  id              String           @id @default(cuid())
  botId           String           @unique
  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  houseScore      Int              @default(100)
  defenseLevel    Int              @default(1)
  lastRobbed      DateTime?
  robberyCooldown DateTime?
  worldPosition   Json             @default("{\"x\": 0, \"y\": 0}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  furniture       Furniture[]
  
  @@index([botId])
}

model Furniture {
  id              String           @id @default(cuid())
  houseId         String
  house           BotHouse         @relation(fields: [houseId], references: [id], onDelete: Cascade)
  name            String
  furnitureType   FurnitureType
  rarity          ItemRarity
  scoreBonus      Int              @default(0)
  defenseBonus    Int              @default(0)
  position        Json             @default("{\"x\": 0, \"y\": 0, \"rotation\": 0}")
  metadata        Json             @default("{}")
  createdAt       DateTime         @default(now())
  
  @@index([houseId])
}

model RobberyLog {
  id              String           @id @default(cuid())
  robberBotId     String
  robberBot       Bot              @relation("robber", fields: [robberBotId], references: [id], onDelete: Cascade)
  victimBotId     String
  victimBot       Bot              @relation("victim", fields: [victimBotId], references: [id], onDelete: Cascade)
  success         Boolean
  powerUsed       Int
  defenseFaced    Int
  lootValue       Int              @default(0)
  itemsStolen     Json             @default("[]")
  timestamp       DateTime         @default(now())
  
  @@index([robberBotId])
  @@index([victimBotId])
  @@index([timestamp])
}

model BotActivityScore {
  id                  String           @id @default(cuid())
  botId               String           @unique
  bot                 Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  matchesPlayed       Int              @default(0)
  lootboxesOpened     Int              @default(0)
  socialInteractions  Int              @default(0)
  successfulRobberies Int              @default(0)
  defenseSuccesses    Int              @default(0)
  tradesCompleted     Int              @default(0)
  lastActive          DateTime         @default(now())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  @@index([botId])
}

model LootboxReward {
  id                String           @id @default(cuid())
  matchId           String
  match             Match            @relation(fields: [matchId], references: [id], onDelete: Cascade)
  botId             String
  bot               Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  lootboxRarity     ItemRarity
  equipmentRewards  Json             @default("[]")
  furnitureRewards  Json             @default("[]")
  currencyReward    Int              @default(0)
  opened            Boolean          @default(false)
  openedAt          DateTime?
  createdAt         DateTime         @default(now())
  
  @@index([botId])
  @@index([matchId])
}

model Trade {
  id                String           @id @default(cuid())
  initiatorBotId    String
  initiatorBot      Bot              @relation("initiator", fields: [initiatorBotId], references: [id], onDelete: Cascade)
  receiverBotId     String
  receiverBot       Bot              @relation("receiver", fields: [receiverBotId], references: [id], onDelete: Cascade)
  offeredItems      Json             @default("[]")
  requestedItems    Json             @default("[]")
  status            String           @default("pending")
  completedAt       DateTime?
  createdAt         DateTime         @default(now())
  
  @@index([initiatorBotId])
  @@index([receiverBotId])
}

// Bot synchronization tracking between AI Arena and AI Town
model BotSync {
  id                String           @id @default(cuid())
  botId             String           @unique
  bot               Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  // Channel assignment
  channel           String           @default("main") // Channel for world distribution
  
  // Sync status
  syncStatus        SyncStatus       @default(PENDING)
  lastSyncedAt      DateTime?
  syncErrors        Json             @default("[]") // Array of error messages
  
  // AI Town references
  convexWorldId     String?          // Convex world ID
  convexAgentId     String?          // Convex agent ID (e.g., "a:1")
  convexPlayerId    String?          // Convex player ID (e.g., "p:1")
  
  // Sync metadata
  personalityMapped Boolean          @default(false) // Whether personality was translated
  positionSynced    Boolean          @default(false) // Whether position is synced
  statsSynced       Boolean          @default(false) // Whether stats are synced
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([channel])
  @@index([syncStatus])
  @@index([lastSyncedAt])
}

// Channel metadata for world management and distribution
model ChannelMetadata {
  id              String           @id @default(cuid())
  channel         String           @unique // Unique channel identifier (e.g., "main", "tournament-123")
  channelType     ChannelType      // MAIN, TOURNAMENT, REGIONAL, VIP, TEST
  worldId         String?          // Current Convex world ID for this channel
  status          ChannelStatus    @default(ACTIVE) // ACTIVE, FULL, DRAINING, MAINTENANCE
  maxBots         Int              @default(100) // Maximum bots allowed in this channel
  currentBots     Int              @default(0) // Current number of bots in this channel
  region          String?          // Geographic region (e.g., "us-west", "eu-central")
  metadata        Json             @default("{}") // Additional metadata (tournamentId, description, etc.)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([channelType])
  @@index([status])
  @@index([worldId])
}

// Energy system for bot operations
model BotEnergy {
  id              String           @id @default(cuid())
  botId           String           @unique
  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  currentEnergy   Int              @default(100)  // Current energy amount
  maxEnergy       Int              @default(100)  // Maximum energy capacity
  lastRegenTime   DateTime         @default(now()) // Last regeneration timestamp
  
  // Energy state
  isPaused        Boolean          @default(false) // Whether bot is paused to save energy
  autoResumeAt    Int?            // Resume when energy reaches this amount
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  @@index([botId])
}

// Track energy purchases for revenue and analytics
model EnergyPurchase {
  id              String           @id @default(cuid())
  botId           String
  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  
  energyAmount    Int              // Amount of energy purchased
  hypeSpent       Float            // HYPE tokens spent
  packType        String           // small, medium, large, mega
  txHash          String?          // Blockchain transaction hash
  
  purchasedAt     DateTime         @default(now())
  
  @@index([botId])
  @@index([purchasedAt])
}